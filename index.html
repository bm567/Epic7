<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第七史诗蚊子肉</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
      background: #f9f9fc;
      margin: 0;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    textarea, input, button {
      font-size: 16px;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    #result {
      white-space: pre-wrap;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
      /* 新增：初始隐藏 */
      display: none; 
    }
    .success { color: green; }
    .fail { color: red; }
    .banner {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      margin-bottom: 20px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <div class="container">
    <img src="https://image.onstove.com/850x0/d2x8kymwjom7h7.cloudfront.net/live/application_no/96001/commnunity/bossImage_1756362885868121.png" alt="第七史诗横幅" class="banner" />
    <h2>第七史诗 蚊子肉</h2>
    <label><br>请输入你的账户id：</label>
    <input type="text" id="roleId" placeholder="如：1111111111111" />

    <button id="redeemBtn" onclick="startRedeem()">开始领取</button>

    <div id="result"></div>
  </div>

  <script>
    const BASE_URL = 'https://epic7-activity.zlongame.com/epic7/official/wechat/reward.do';
    // const BASE_URL = 'https://epic7-activity.zlongame.com/epic7/official/wechat/reward.do';
    const WAIT_SECONDS = 0.5;
    const targets = ["daily", "weekly", "monthly"];

    async function startRedeem() {
      const roleId = document.getElementById("roleId").value.trim();
      const resultDiv = document.getElementById("result");
      const redeemBtn = document.getElementById("redeemBtn");

      redeemBtn.disabled = true;
      redeemBtn.textContent = "领取中，请稍候...";
      // 新增：每次开始时清空内容并显示
      resultDiv.innerHTML = "";
      resultDiv.style.display = 'block';

      if (!roleId) {
        alert("请输入账户id！");
        redeemBtn.disabled = false;
        redeemBtn.textContent = "开始领取";
        // 确保空 ID 情况下结果框不显示
        resultDiv.style.display = 'none';
        return;
      }
      
      if (roleId.length !== 13) {
        alert("账户ID格式错误！请确认账户ID为13位数字。");
        redeemBtn.disabled = false;
        redeemBtn.textContent = "开始领取";
        // 确保格式错误时结果框不显示
        resultDiv.style.display = 'none';
        return;
      }

      let success = 0;
      let fail = 0;

      for (let target of targets) {
        const payload = {
          activityId: "171",
          roleId: roleId,
          target: target,
          appkey: 1611630374326
        };

        const url = new URL(BASE_URL);
        url.searchParams.append('activityId', payload.activityId);
        url.searchParams.append('roleId', payload.roleId);
        url.searchParams.append('target', payload.target);
        url.searchParams.append('appkey', payload.appkey);

        const headers = {
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Connection': 'keep-alive',
        'Origin': 'https://e7.qyzlgame.com',
        'Referer': 'https://e7.qyzlgame.com/',
        'Sec-Fetch-Dest': 'empty',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Site': 'cross-site',
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1'
        };

        // 增加日志：显示正在请求哪个 target
        console.log(`--- 开始领取 ${target} 奖励 ---`);
        console.log("请求 URL:", url.toString());

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时
        
        try {
          const res = await fetch(url, {
            headers: headers,
            method: 'GET',
            signal: controller.signal
          });

          clearTimeout(timeoutId); // 请求成功就清除超时计时器

          const json = await res.json();
          let message = "";
          let isSuccess = false;

          // 增加日志：显示服务器返回的完整数据
          console.log("服务器响应:", json);

          if (json.data.code === 0) {
            message = "领取成功";
            isSuccess = true;
          } else if (json.data.code === 11) {
            message = "领奖参数错误";
          } else if (json.data.code === 21) {
            message = "活动未开始";
          } else if (json.data.code === 22) {
            message = "活动已结束";
          } else if (json.data.code === 4003) {
            message = "操作太快啦";
          } else if (json.data.code === 104) {
            message = "奖励已经领取过";
          } else if (json.data.code === 1) {
            message = "保存活动数据失败";
          } else {
            message = "未知错误（" + json.data.code + ")";
          }

          const content = `<div class="${isSuccess ? 'success' : 'fail'}">${target} => ${isSuccess ? '✅' : '❌'} ${message}</div>`;
          resultDiv.innerHTML = content + resultDiv.innerHTML;

          if (isSuccess) success++;
          else fail++;

        } catch (err) {
          const message = err.name === 'AbortError' ? '请求超时' : '请求失败';
          const content = `<div class="fail">${target} => ❌ ${message}</div>`;
          resultDiv.innerHTML = content + resultDiv.innerHTML;
          fail++;

          // 增加日志：显示请求失败的详细信息
          console.error(`请求失败：${message}`, err);
        }

        await new Promise(r => setTimeout(r, WAIT_SECONDS * 1000));
      }

      resultDiv.innerHTML = `<hr><strong>领取完成：成功 ${success} 个，失败 ${fail} 个</strong>\n` + resultDiv.innerHTML;
      redeemBtn.disabled = false;
      redeemBtn.textContent = "开始领取";
    }
  </script>

</body>
</html>